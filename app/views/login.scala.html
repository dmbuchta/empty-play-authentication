@import b4.vertical.fieldConstructor
@import controllers.security.SecurityController.NewUserForm
@(loginForm: Form[models.User], newUserForm: Form[NewUserForm], ssoClientId: String = null)
@main("Login") {
    <style>
    #login-header {
        margin: 40px 0px;
    }

    #googleSsoButton {
        position: relative;
    }

    #googleSsoButton img {
        position: absolute;
        left: 0px;
        top: 10px;
    }
    </style>
} {
    <div class="row">
        <div class="col-lg-4 col-md-6 col-sm-8 col-xs-10 offset-lg-4 offset-md-3 offset-sm-2 offset-xs-1">
            <h3 id="login-header" class="text-xs-center">Log in to your account</h3>
            <div id="login-alerts">
            @if(loginForm("email").value() != null) {
                <div class="alert alert-danger" role="alert">
                    There was a problem with your login
                </div>
            }
            </div>
            @b4.form(security.routes.SecurityController.login(), 'id -> "login-form", Symbol("data-toggle") -> "validator") {
                @b4.inputWrapped("email", loginForm("email"), 'placeholder -> "Email Address", '_class -> "has-feedback") { input =>
                    <div class="input-group">
                        <div class="input-group-addon"><i class="fa fa-user"></i></div>
                        @input
                    </div>
                    <div class="form-control-feedback">
                        <span class="help-block with-errors small"></span>
                    </div>
                }
                @b4.inputWrapped("password", loginForm("password"), 'placeholder -> "Password", '_class -> "has-feedback",
                    'required -> "true", 'autocomplete -> "off") { input =>
                    <div class="input-group">
                        <div class="input-group-addon"><i class="fa fa-lock"></i></div>
                        @input
                    </div>
                    <div class="form-control-feedback">
                        <span class="help-block with-errors small"></span>
                    </div>
                }
                <div class="clearfix">
                    <button type="submit" class="btn btn-primary btn-lg btn-block">Login</button>
                    <a class="float-xs-right small" href="#" data-toggle="modal" data-target="#sign-up-modal">
                        Create Account</a>
                </div>
            }
            @if(ssoClientId != null) {
                <div class="text-xs-center">
                    <p class="h5"><strong>or</strong></p>
                </div>
                <div id="googleSsoButton" class="customGPlusSignIn btn btn-secondary btn-lg btn-block mt-1">
                    <img src="@routes.Assets.at("images/g-normal.png")"/>
                    <span class="buttonText">Login with Google</span>
                </div>
            }
        </div>
    </div>
    @modal("Create Account", "sign-up-modal")("Sign Up") {
        <div class="row">
            <div class="col-xs-8 offset-xs-2">
            @b4.form(action = security.routes.SecurityController.createAccount(), 'id -> "sign-up-form", Symbol("data-toggle") -> "validator") {
                @b4.inputWrapped("email", newUserForm("newEmail"), '_label -> "Email Address",
                    'placeholder -> "Email", '_class -> "has-feedback") { input =>
                    @input
                    <div class="form-control-feedback">
                        <span class="help-block with-errors small"></span>
                    </div>
                }
                @b4.inputWrapped("password", newUserForm("newPassword"), '_label -> "Password",
                    'placeholder -> "Password", '_class -> "has-feedback", 'autocomplete -> "off") { input =>
                    @input
                    <div class="form-control-feedback">
                        <span class="help-block with-errors small"></span>
                    </div>
                }
                @b4.inputWrapped("password", newUserForm("confirmPassword"), '_label -> "Confirm Password",
                    'placeholder -> "Confirm Password", '_class -> "has-feedback", 'autocomplete -> "off",
                    Symbol("data-match") -> "#newPassword", Symbol("data-match-error") -> "Passwords don't match") { input =>
                    @input
                    <div class="form-control-feedback">
                        <span class="help-block with-errors small"></span>
                    </div>
                }
                <button type="submit" class="hidden-xs-up"/>
            }
            </div>
        </div>
    }

} {
    <script src="@routes.Assets.at("javascripts/login.js")" type="text/javascript"></script>
    @if(ssoClientId != null) {
        <script src="https://apis.google.com/js/platform.js?onload=startSSOFlow" async defer></script>
        <script>
                function attachSignin(element) {
                    auth2.attachClickHandler(element, {},
                            function (googleUser) {
                                $.ajax("@security.sso.routes.GoogleSsoController.login()", {
                                    type: "POST",
                                    data: {
                                        id_token: googleUser.getAuthResponse().id_token
                                    },
                                    success: function (response) {
                                        if (response.success) {
                                            return window.location = response.url;
                                        }
                                        var message = response.message || "An error occurred using Single Sign On";
                                        if (message == "No account") {
                                            return createAccountFromGoogleUser(googleUser);
                                        }
                                        createAlert("danger", message, "#login-alerts")
                                    },
                                    error: function (response) {
                                        createAlert("danger", "An error occurred using Single Sign On", "#login-alerts")
                                    }
                                });
                            }, function (error) {
                                alert(JSON.stringify(error, undefined, 2));
                            });
                }
                function startSSOFlow() {
                    gapi.load('auth2', function () {
                        // Retrieve the singleton for the GoogleAuth library and set up the client.
                        auth2 = gapi.auth2.init({
                            client_id: '@ssoClientId',
                            cookiepolicy: 'single_host_origin',
                            scope: 'profile email'
                        });
                        attachSignin(document.getElementById('googleSsoButton'));
                    });
                }
                function createAccountFromGoogleUser(googleUser) {
                    var profile = googleUser.getBasicProfile();
                    $("input[name='newEmail']").val(profile.getEmail());
                    createAlert("info", "Please create an account", "#sign-up-modal-alerts");
                    $("#sign-up-modal").modal("show");
                }
        </script>
    }
}